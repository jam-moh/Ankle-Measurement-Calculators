<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bland–Altman Plot - Ankle Plantar Flexion Strength</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f6f8;
    color: #222;
    padding: 20px;
    text-align: center;
  }
  h1 {
    color: #007ACC;
  }
  textarea {
    width: 90%;
    height: 80px;
    margin: 10px 0;
    font-size: 1rem;
  }
  button {
    background-color: #00A896;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 1rem;
    cursor: pointer;
    margin-bottom: 20px;
  }
  button:hover {
    background-color: #028F79;
  }
  canvas {
    border: 1px solid #ccc;
    background-color: white;
    margin-top: 20px;
  }
</style>
</head>
<body>

<h1>Bland–Altman Plot</h1>
<p>Paste paired data (Trial 1, Trial 2) separated by comma, tab, or space, one pair per line:</p>

<textarea id="dataInput" placeholder="Example: 40 42&#10;45 44&#10;50 52"></textarea>
<br>
<button onclick="drawPlot()">Draw Plot</button>

<canvas id="baCanvas" width="700" height="500"></canvas>

<script>
function drawPlot() {
    const rawData = document.getElementById('dataInput').value.trim();
    if (!rawData) return alert('Please paste your paired data.');

    // Parse data (comma, tab, or space)
    const pairs = rawData.split('\n').map(line => {
        const parts = line.trim().split(/[\t, ]+/).map(Number);
        return parts;
    });

    // Validation
    if (pairs.some(p => p.length !== 2 || p.some(isNaN))) {
        return alert('Data format error. Each line must have two numbers separated by comma, tab, or space.');
    }

    // Compute means and differences
    const means = pairs.map(p => (p[0] + p[1])/2);
    const diffs = pairs.map(p => p[1] - p[0]);

    const n = diffs.length;
    const meanDiff = diffs.reduce((a,b)=>a+b,0)/n;
    const sdDiff = Math.sqrt(diffs.reduce((a,b)=>a + (b-meanDiff)**2, 0)/(n-1));

    const loaUpper = meanDiff + 1.96*sdDiff;
    const loaLower = meanDiff - 1.96*sdDiff;

    // Canvas setup
    const canvas = document.getElementById('baCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Margins
    const margin = 60;
    const plotWidth = canvas.width - 2*margin;
    const plotHeight = canvas.height - 2*margin;

    // Scale calculations
    const minX = Math.min(...means) - 5;
    const maxX = Math.max(...means) + 5;
    const minY = Math.min(loaLower, ...diffs) - 5;
    const maxY = Math.max(loaUpper, ...diffs) + 5;

    const scaleX = plotWidth/(maxX - minX);
    const scaleY = plotHeight/(maxY - minY);

    function xToCanvas(x){ return margin + (x - minX)*scaleX; }
    function yToCanvas(y){ return canvas.height - margin - (y - minY)*scaleY; }

    // Draw axes
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(margin, margin);
    ctx.lineTo(margin, canvas.height-margin);
    ctx.lineTo(canvas.width-margin, canvas.height-margin);
    ctx.stroke();

    // Axis labels
    ctx.fillStyle = '#000';
    ctx.font = '14px Arial';
    ctx.fillText('Mean of Trials (Newton)', canvas.width/2 - 50, canvas.height - 15);
    ctx.save();
    ctx.translate(15, canvas.height/2 + 50);
    ctx.rotate(-Math.PI/2);
    ctx.fillText('Difference (Trial2 - Trial1) [Newton]', 0,0);
    ctx.restore();

    // Draw bias line
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.setLineDash([5,5]);
    ctx.beginPath();
    ctx.moveTo(xToCanvas(minX), yToCanvas(meanDiff));
    ctx.lineTo(xToCanvas(maxX), yToCanvas(meanDiff));
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'red';
    ctx.fillText(`Bias: ${meanDiff.toFixed(2)} N`, xToCanvas(maxX)-80, yToCanvas(meanDiff)-5);

    // Draw ±1.96 SD lines
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.setLineDash([5,5]);
    ctx.beginPath();
    ctx.moveTo(xToCanvas(minX), yToCanvas(loaUpper));
    ctx.lineTo(xToCanvas(maxX), yToCanvas(loaUpper));
    ctx.stroke();
    ctx.fillStyle = 'blue';
    ctx.fillText(`+1.96 SD: ${loaUpper.toFixed(2)} N`, xToCanvas(maxX)-90, yToCanvas(loaUpper)-5);

    ctx.beginPath();
    ctx.moveTo(xToCanvas(minX), yToCanvas(loaLower));
    ctx.lineTo(xToCanvas(maxX), yToCanvas(loaLower));
    ctx.stroke();
    ctx.fillText(`-1.96 SD: ${loaLower.toFixed(2)} N`, xToCanvas(maxX)-90, yToCanvas(loaLower)-5);
    ctx.setLineDash([]);

    // Draw hollow circles for data points
    ctx.strokeStyle = '#007ACC';
    ctx.lineWidth = 2;
    pairs.forEach((p,i)=>{
        const cx = xToCanvas(means[i]);
        const cy = yToCanvas(diffs[i]);
        ctx.beginPath();
        ctx.arc(cx, cy, 6, 0, 2*Math.PI);
        ctx.stroke();
    });
}
</script>

</body>
</html>
